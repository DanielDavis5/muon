# SPDX-FileCopyrightText: Stone Tickle <lattis@mochiro.moe>
# SPDX-License-Identifier: GPL-3.0-only

image: alpine/latest
secrets:
  - 2fe5fef6-db89-4410-8147-07e314589d18
  - 18083346-dfba-4050-bc05-413561f99228
packages:
  - curl-dev
  - libarchive-dev
  - pkgconf-dev
  - samurai
  - python3 # for project tests and meson docs
  - py3-yaml # for meson docs
  - scdoc # for docs of course
  - mandoc # for docs of course
  - clang # for testing

  # for static builds
  - acl-static
  - brotli-static
  - bzip2-static
  - curl-static
  - expat-static
  - libarchive-static
  - lz4-static
  - nghttp2-static
  - openssl-libs-static
  - xz-dev
  - zlib-static
  - zstd-static

  # for releases
  - rsync
sources:
  - https://git.sr.ht/~lattis/muon
environment:
  PKG_CONFIG_PATH: /usr/lib/pkgconfig
tasks:
  - push_to_gh_mirror: |
      cd muon
      .builds/push_to_gh_mirror.sh
  - install_tcc: |
      sudo sh -c "echo http://dl-cdn.alpinelinux.org/alpine/edge/testing >> /etc/apk/repositories"
      sudo apk update
      sudo apk add tcc
  - build_gcc: |
      cd muon
      CC=gcc .builds/fullbootstrap.sh -Dbuildtype=release -Dstatic=true -Dwebsite=true
  - build_tcc: |
      cd muon
      CC=tcc .builds/bootstrap.sh build-tcc
  - test_gcc: |
      cd muon/build
      CC=gcc ./muon test -j$(nproc) -d dots
  - test_clang: |
      cd muon/build
      CC=clang ./muon test -j$(nproc) -d dots
  - build_small: |
      cd muon
      CC=gcc build/muon setup \
        -Dbuildtype=minsize \
        -Dstatic=true \
        -Dsamurai=enabled \
        -Dlibcurl=disabled \
        -Dlibarchive=disabled \
        build-small
      samu -C build-small
  - release: |
      cd muon
      .builds/prepare_release_docs.sh build
      .builds/prepare_binary.sh build edge-amd64-linux-static
      .builds/prepare_binary.sh build-small edge-amd64-linux-static-small
      .builds/deploy.sh / -r --delete build/doc/website
      .builds/deploy.sh /releases/edge -r --delete build/doc/docs
      .builds/deploy.sh /releases/edge \
        build/muon-edge-amd64-linux-static \
        build/muon-edge-amd64-linux-static.md5 \
        build-small/muon-edge-amd64-linux-static-small \
        build-small/muon-edge-amd64-linux-static-small.md5
artifacts:
  - muon/build/muon-edge-amd64-linux-static
  - muon/build/muon-edge-amd64-linux-static.md5
  - muon/build-small/muon-edge-amd64-linux-static-small
  - muon/build-small/muon-edge-amd64-linux-static-small.md5
  - muon/build/doc/docs/man.tar.gz
