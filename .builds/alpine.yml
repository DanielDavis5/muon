image: alpine/latest
secrets:
  - 2fe5fef6-db89-4410-8147-07e314589d18
packages:
  - curl-dev
  - libarchive-dev
  - pkgconf-dev
  - samurai
  - python3 # for project tests and meson docs
  - py3-yaml # for meson docs
  - scdoc # for docs of course
  - mandoc # for docs of course

  # for static builds
  - acl-static
  - brotli-static
  - bzip2-static
  - curl-static
  - expat-static
  - libarchive-static
  - lz4-static
  - nghttp2-static
  - openssl-libs-static
  - xz-dev
  - zlib-static
  - zstd-static

  # for releases
  - rsync
sources:
  - https://git.sr.ht/~lattis/muon
tasks:
  - build: |
      cd muon
      .builds/fullbootstrap.sh -Dstatic=true -Dwebsite=true
  - test: |
      cd muon
      build/muon -C build test -d dots
  - release: |
      cd muon/build
      arch=amd64-linux-static
      strip muon
      mv muon "muon-$arch"
      md5sum "muon-$arch" > "muon-$arch.md5"
      ../.builds/deploy.sh "$arch"
artifacts:
  - muon/build/muon-amd64-linux-static
  - muon/build/muon-amd64-linux-static.md5
